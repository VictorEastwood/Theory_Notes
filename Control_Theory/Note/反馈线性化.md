# NONLINEAR BACKSTEPPING CONTROL & FEEDBACK LINEARIZATION
# 非线性反步控制与反馈线性化
---
## 1. 系统简介
这个系统是一个典型的质量-弹簧系统，其中包含一个非线性弹簧和一个质量块。让我们重新绘制并解释这个系统。

### 示意图
```
  |---/\/\/\---[m]--->
  |    k       m     F
```

### 系统解释

1. **质量块 \( m \)**：
   - 质量块 \( m \) 可以沿着水平线自由移动。
   - 位置 \( x \) 描述了质量块的位移。

2. **弹簧 \( \alpha \)**：
   - 弹簧连接在固定点和质量块之间。
   - 弹簧具有非线性恢复力，其力与位移的立方成正比，即 \( \alpha x^3 \)。

3. **外力 \( F \)**：
   - 外力 \( F \) 作用在质量块上，推动或拉动质量块。

4. **运动方程**：
   - 系统的运动方程为：
     \[
     m\ddot{x} + \alpha x^3 = F
     \]
   - 其中，\( m \ddot{x} \) 是质量块的惯性力，\( \alpha x^3 \) 是弹簧的恢复力，\( F \) 是外力。

### 解释
- 当外力 \( F \) 作用在质量块上时，质量块会在水平线上移动。
- 弹簧的恢复力与位移的立方成正比，这意味着弹簧的恢复力是非线性的。
- 系统的运动由上述运动方程描述，考虑了质量块的惯性力和弹簧的非线性恢复力。

这个系统的行为可以通过求解运动方程来研究，通常需要使用数值方法来处理非线性方程。

## 2. 非线性反馈线性化

令：
- \( F = u \) 为控制输入 Input
- \( x_1 = x \) 为质量块的位移 Displacement
- \( x_2 = \dot{x} \) 为质量块的速度 Velocity

控制目标为：使质量块的位移 \( x_1 \) 跟踪给定的参考信号 \( x_d \)。
\(x_1 = x_ {1d}\) 时，系统的稳态误差为零。
建立状态空间方程：
$$
\begin{cases}
\dot{x_1} = x_2 \\
\dot{x_2} = \frac{1}{m} (u - \alpha x_1^3)
\end{cases}
$$
这样的系统叫做链式系统

$$
\begin{aligned}
\dot{x_1} &= x_2 \tag{1} \\
\end{aligned}
$$

$$
\begin{aligned}
\dot{x_2} &= \frac{1}{m} (u - \alpha x_1^3) \tag{2}
\end{aligned}
$$
我们引入一个误差函数,目标是使得误差函数收敛到0
$$
\begin{aligned}
e &= x_{1d}-x_1   \tag{3}
\end{aligned}
$$
我们对误差函数求导
$$
\begin{aligned}
\dot{e} &= \dot{x}_{1d}-\dot{x}_1 \\
        &= \dot{x}_{1d}-x_2 \tag{4}
\end{aligned}
$$
所以我们需要找到一个Lyapunov函数$V(e)$,使得
$$
\begin{aligned}
V(e) :PD \\
\dot{V}(e) :ND
\end{aligned}
$$
所以我们设计一个Lyapunov函数
$$
\begin{aligned}
V_1 &= \frac{1}{2}e^2 \tag{5}
\end{aligned}
$$
对Lyapunov函数求导
$$
\begin{aligned}
\dot{V}_1 &= \frac{\partial V_1}{\partial e}\cdot \frac{\partial e}{\partial t} \\
          &= e\dot{e} \\
          &= e(\dot{x}_{1d}-x_2) \tag{6}
\end{aligned}
$$
我们设计$\dot{x}_{1d}-x_2 = -k_1e$
其中$k_1$是一个正定的常数,我们叫它controller gain
我们希望$\dot{V}_1$是负定的，所以我们令
$$
\begin{aligned}
x_{2d} = \dot{x}_{1d}+k_1e \tag{7}
\end{aligned}
$$
我们就有了一个新的目标：$x_2 \rightarrow x_{2d} $
令
$$
\begin{aligned}
\delta  = x_{2d}-x_2 \tag{8}
\end{aligned}
$$

把8式代入6式
$$
\begin{aligned}
\dot{V}_1 &= e(\dot{x}_{1d}-(x_{2d}-\delta)) \\
\end{aligned}
$$
代入7式
$$
\begin{aligned}
\dot{V}_1 &= e(\dot{x}_{1d}-x_{2d}+\delta) \\
          &= e(\dot{x}_{1d}-\dot{x}_{1d}-k_1e+\delta) \\
          &= -k_1e^2 +e\delta \tag{9}
\end{aligned}
$$
对\( \delta \) 求导并代入2式代入4式
$$
\begin{aligned}
\dot{\delta}&= \dot{x}_{2d}-\dot{x}_2 \\
            &= \ddot{x}_{1d}+k_1\dot{e}-\dot{x}_2 \\
            &= \ddot{x}_{1d}+k_1\dot{e}+(-\frac{1}{m}(u-\alpha x_1^3))\\
            &= \ddot{x}_{1d}+k_1(\dot{x}_{1d}-x_2)+(-\frac{1}{m}(u-\alpha x_1^3)) \\
            &= \ddot{x}_{1d}+k_1(\dot{x}_{1d}-x_2)+\frac{\alpha}{m}x_1^3-\frac{1}{m}u\tag{10}
\end{aligned}
$$
所以我们产生了一个新的目标：$\delta \rightarrow 0$并且我们希望$e \rightarrow 0$
所以我们设计一个新的Lyapunov函数包含$e$和$\delta$，满足：
$$
\begin{aligned}
v_{e,\delta} : PD \\
\dot{v}_{e,\delta} : ND
\end{aligned}
$$
故该Lyapunov函数为：
$$
\begin{aligned}
V_2 &= V_1 + \frac{1}{2}\delta^2 
\end{aligned}
$$
对Lyapunov函数求导
$$
\begin{aligned}
\dot{V}_2 &= \dot{V}_1 + \delta\dot{\delta} 
\end{aligned}
$$
代入9式可得：
$$
\begin{aligned}
\dot{V}_2 &= -k_1e^2 +e\delta + \delta\dot{\delta}\\
            &= -k_1e^2 +\delta(e+\dot{\delta})\\
\end{aligned}
$$
由于我们希望$\dot{V}_2$是负定的，并且$-k_1e^2$是负定的，所以我们希望$\delta(e+\dot{\delta})$是负定的，所以我们令
$$
\begin{aligned}
e+\dot{\delta} = -k_2\delta 
\end{aligned}
$$
其中$k_2$我们也希望是一个正定的常数，我们叫它controller gain
代入10式
$$
\begin{aligned}
e+\ddot{x}_{1d}+k_1(\dot{x}_{1d}-x_2)+\frac{\alpha}{m}x_1^3-\frac{1}{m}u = -k_2\delta 
\end{aligned}
$$
可以推断出
$$
\begin{aligned}
u = me+m\ddot{x}_{1d}+mk_1(\dot{x}_{1d}-x_2)+\alpha x_1^3+mk_2\delta \tag{11}
\end{aligned}
$$
下面进行验证
将8式代入4式
$$
\begin{aligned}
\dot{e} &= \dot{x}_{1d}-x_2+\delta \\
\end{aligned}
$$
再代入7式
$$
\begin{aligned}
\dot{e} &= -k_1e+\delta 
\end{aligned}
$$

将11式代入10
$$
\begin{aligned}
\dot{\delta} &=  \ddot{x}_{1d}+k_1(\dot{x}_{1d}-x_2)+\frac{\alpha}{m}x_1^3-e-\ddot{x_{1d}}-k_1(\dot{x}_{1d}-x_2)-\alpha x_1^3 - k_2\delta \\
            &= -e-k_2\delta
\end{aligned}
$$
写在一起：
$$
\begin{aligned}
\begin{bmatrix}
\dot{e} \\
\dot{\delta}
\end{bmatrix} &= \begin{bmatrix}
-k_1 & 1 \\
-1 & -k_2
\end{bmatrix} \begin{bmatrix}
e \\
\delta
\end{bmatrix}
\end{aligned}
$$
## 3. 习题
系统状态方程为：
$$
\begin{cases}
\dot{x_1} = x_1^2+x_2\tag1\\
\dot{x_2} = x_1 +u\\
\end{cases}
$$
我们的目标是使得$x_1 \rightarrow x_{1d}$
这个系统是一个非线性系统，遵循链式法则，实际上整个系统是在做积分
我们需要两步：
GOAL1:我们需要设计一个中间输入$x_{2d}$使得$x_1 \rightarrow x_{1d}$，意思就是当$x_2 = x_{2d}$时，$x_1 \rightarrow x_{1d}$
GOAL2:我们需要设计一个输入$u$使得$x_2 \rightarrow x_{2d}$

**Step1：寻找一个 $x_{2d}$,使得$x_1 \rightarrow x_{1d}$,于是 $e = x_{1d}-x_1$ , $e \rightarrow 0$**
设计一个Lyapunov函数
$$
\begin{aligned}
V_{(e)} &= \frac{1}{2}e^2\\
\dot{V}_{(e)} &= e\dot{e} \\
\end{aligned}
$$
要想使系统稳定，我们需要令$V_{(e)}$是一个正定函数，并且$\dot{V}_{(e)}$是一个负定函数。
由于$V_{(e)}$已经是一个正定函数，我们只需要令$\dot{V}_{(e)}$是一个负定函数就可以了。

$$
\begin{aligned}
\dot{V}_{(e)} &= e\dot{e} \\
            &= e(\dot{x}_{1d}-\dot{x}_1) \\
            &= e(\dot{x}_{1d}-x_1^2-x_2) \\
\end{aligned}
$$
我们需要使$\dot{V}_{(e)} $是一个负定函数，所以我们令
$$
\begin{aligned}
\dot{V}_{(e)}  = e\dot{e} = -k_1e^2
\end{aligned}
$$
这样我们可以得到
$$
\begin{aligned}
\dot{x}_{1d}-x_1^2-x_2 = -k_1e\\
\downarrow \\
x_2 = \dot{x}_{1d}-x_1^2+k_1e
\end{aligned}
$$
这里的$x_2$就是我们寻找到的中间输入$x_{2d}$
所以
$$
\begin{aligned}
x_{2d} = \dot{x}_{1d}-x_1^2+k_1e
\end{aligned}
$$

因为这时候如果当$x_2 = x_{2d}$时，$x_1 \rightarrow x_{1d}$，这时候我们就完成了GOAL1
**Step2：设计一个输入$u$使得$x_2 \rightarrow x_{2d}$**
故设计$\delta = x_{2d}-x_2$，$\delta \rightarrow 0$
所以设计的Lyapunov函数需要包含$e$和$\delta$
当$e \rightarrow 0$和$\delta \rightarrow 0$时，系统是稳定的
$$
\begin{aligned}
V_{(e,\delta)} &= \frac{1}{2}e^2 + \frac{1}{2}\delta^2 \\
\dot{V}_{(e,\delta)} &= e\dot{e} + \delta\dot{\delta} \\
\end{aligned}
$$
又因为
$$
\begin{aligned}
x_2 = x_{2d} - \delta = \dot{x}_{1d}-x_1^2+k_1e - \delta
\end{aligned}
$$
所以
$$
\begin{aligned}
\dot{V} = e\dot{e} + \delta\dot{\delta} &= e(\dot{x}_{1d}-x_1^2-x_2) + \delta \dot{\delta}\\
\end{aligned}
$$
代入$x_2 = \dot{x}_{1d}-x_1^2+k_1e - \delta $
$$
\begin{aligned}
\dot{V} &= e(\dot{x}_{1d}-x_1^2-\dot{x}_{1d}+x_1^2-k_1e+\delta) + \delta \dot{\delta} \\
        &= e(-k_1e+\delta) + \delta \dot{\delta} \\
        &= -k_1e^2 + \delta(e+\dot{\delta}) \\
\end{aligned}
$$
我们需要使$\dot{V}$是一个负定函数，并且$-k_1e^2$是一个负定函数，所以我们需要使$\delta(e+\dot{\delta})$是一个负定函数，故我们令
$$
\begin{aligned}
e+\dot{\delta} = -k_2\delta
\end{aligned}
$$
所以
$$
\begin{aligned}
e+\dot{\delta} &= e+(\dot x_{2d}-\dot x_2) \\
\end{aligned}
$$
计算$\dot x_{2d}$
$$
\begin{aligned}
x_{2d} &= \dot x_{1d}-x_1^2+k_1e \\
&\Downarrow \text{求导}\\
\dot x_{2d} &= \ddot x_{1d}-2x_1\dot x_1+k_1\dot e \\
\end{aligned}
$$
因为
$$
\begin{aligned}
\dot x_2 &= x_1+u \\
\end{aligned}
$$
所以
$$
\begin{aligned}
e+\dot{\delta} &= e+(\ddot x_{1d}-2x_1\dot x_1+k_1\dot e-x_1-u) \\
&\Downarrow \text{代入}\dot{x_1} = x_1^2+x_2\\
&= e+k_1\dot e+\ddot x_{1d}-2x_1(x_1^2+x_2)-x_1-u \\
& = -k_2\delta = -k_2(x_{2d}-x_2) \\
\end{aligned}
$$
最终我们得到了我们想要的控制输入$u$

$$
\begin{aligned}
u = e+k_1\dot e+\ddot x_{1d}-2x_1(x_1^2+x_2)-x_1+k_2 \delta\\
\end{aligned}
$$
代入$ e = x_{1d}-x_1，\dot{e} = \dot{x}_{1d}-(x_1^2+x_2)，\delta = x_{2d}-x_2$
可得
$$
\begin{aligned}
u = x_{1d}-x_1+k_1(\dot{x}_{1d}-(x_1^2+x_2))+\ddot x_{1d}-2x_1(x_1^2+x_2)-x_1+k_2(x_{2d}-x_2)
\end{aligned}
$$

## 4. 总结
通过系统的传递函数，我们可以通过控制输入u来改变$x_2$，通过$x_2$来改变$x_1$，从而实现$x_1 \rightarrow x_{1d}$的目标。但是我们设计控制器是反过来，从$x_1$开始设计，通过$x_1$来设计$x_2$，再通过$x_2$来设计$u$，就像走迷宫一样，从终点开始走，往起点走，所以这个方法叫做反步控制。因此我们要想获得一个稳定的$x_1$，我们需要找到一个合适的$x_2$的值，要想$x_2$趋向于我们想要的合适的值，我们需要找到一个合适的$u$的值，这就是反步控制的思想。

所以我们在第一步中设计了一个Lyapunov函数，使得$x_1$趋向于$x_{1d}$,即$e \rightarrow 0$，这样我们就找到了一个合适的$x_2$的值，这个值就是$x_{2d}$。

在第二步中，我们设计了一个新的Lyapunov函数，使得$x_2$趋向于$x_{2d}$，即$\delta \rightarrow 0$，这样我们就找到了一个合适的$u$的值，这个值就是我们的控制输入。


